<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Trovapp Original Fix</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Ripristino stile originale */
        * { -webkit-tap-highlight-color: transparent; }
        body { background-color: #F2F2F7; font-family: -apple-system, sans-serif; margin: 0; padding: 0; }
        
        /* FIX: Permettiamo alla pagina di scorrere naturalmente */
        #mainContainer { padding: 16px; padding-bottom: 120px; min-height: 100vh; }

        /* Griglia bottoni originale */
        #navGrid { display: grid; grid-template-cols: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        
        /* Stile tag blu richiesto */
        .tag-pill { background-color: #2563eb !important; color: white !important; font-weight: 700; padding: 4px 10px; border-radius: 8px; font-size: 10px; text-transform: uppercase; margin: 2px; display: inline-block; }

        /* Card oggetti */
        .scroll-area { display: grid; grid-template-cols: repeat(2, 1fr); gap: 12px; margin-top: 20px; }
        .item-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .item-card img { width: 100%; height: 100px; object-fit: cover; }
        
        /* Tasto + Blu originale in basso fisso */
        #addButton { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            background-color: #2563eb; color: white; width: 65px; height: 65px; 
            border-radius: 9999px; box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3); 
            z-index: 100; display: flex; align-items: center; justify-content: center; font-size: 30px; 
        }

        /* Smart Menu */
        #smartMenu { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: flex-end; visibility: hidden; opacity: 0; transition: 0.3s; }
        #smartMenu.active { visibility: visible; opacity: 1; }
        #smartMenuContent { background: white; width: 100%; border-radius: 30px 30px 0 0; padding: 25px; transform: translateY(100%); transition: 0.4s; }
        #smartMenu.active #smartMenuContent { transform: translateY(0); }
    </style>
</head>
<body>

    <div id="mainContainer">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-black italic uppercase tracking-tighter">TROVAPP</h1>
                <p class="text-[9px] font-bold text-blue-600 uppercase tracking-widest">Cloud Sync Mode</p>
            </div>
            <div class="flex gap-2">
                <button onclick="esportaDati()" class="bg-zinc-900 text-white px-3 py-2 rounded-lg text-[10px] font-black uppercase">BACKUP</button>
            </div>
        </header>

        <input type="text" id="searchInput" oninput="aggiorna()" placeholder="Cerca un oggetto..." class="w-full p-4 bg-white rounded-2xl shadow-sm mb-6 outline-none font-medium">

        <div id="homeNav">
            <nav id="navGrid"></nav>
            <button onclick="apriMenuNuovoSpazio()" class="w-full py-5 border-2 border-dashed border-gray-300 rounded-[24px] text-gray-400 font-black italic uppercase text-xs mb-8">
                + NUOVO SPAZIO
            </button>
        </div>

        <div id="itemsGrid" class="scroll-area"></div>
    </div>

    <button id="addButton" onclick="apriModale()"><i class="fa-solid fa-plus"></i></button>

    <div id="smartMenu" onclick="chiudiSmartMenu()">
        <div id="smartMenuContent" onclick="event.stopPropagation()">
            <h2 id="smTitle" class="text-center font-black italic uppercase text-xl mb-6">OPZIONI</h2>
            <button onclick="mostraRinomina()" class="w-full p-4 bg-gray-100 rounded-2xl mb-3 font-bold uppercase">Rinomina</button>
            <button onclick="azioneSmart('colore')" class="w-full p-4 bg-gray-100 rounded-2xl mb-3 font-bold uppercase">Cambia Colore</button>
            <button onclick="mostraConfermaElimina()" class="w-full p-4 bg-red-50 text-red-600 rounded-2xl font-bold uppercase">Elimina</button>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 z-[300] bg-[#F2F2F7] p-6 overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-black italic uppercase">SCHEDA OGGETTO</h3>
            <button onclick="chiudiModale()" class="text-3xl">&times;</button>
        </div>
        
        <div class="bg-white p-6 rounded-[30px] shadow-sm mb-4">
            <div class="flex gap-4 mb-4">
                <label class="w-20 h-20 bg-gray-100 rounded-2xl flex items-center justify-center text-blue-600">
                    <i class="fa-solid fa-camera fa-xl"></i>
                    <input type="file" id="fIn" class="hidden" onchange="caricaFoto()">
                </label>
                <div id="gallery" class="flex gap-2"></div>
            </div>
            <input id="nIn" type="text" placeholder="Cosa?" class="w-full p-4 bg-gray-50 rounded-xl font-bold mb-4 outline-none">
            
            <div class="flex items-center justify-between bg-zinc-900 text-white p-4 rounded-xl">
                <span class="font-black uppercase">QTY</span>
                <div class="flex gap-6 items-center">
                    <button onclick="changeQty(-1)" class="text-2xl">-</button>
                    <span id="qtyVal" class="font-bold">1</span>
                    <button onclick="changeQty(1)" class="text-blue-400 text-2xl">+</button>
                </div>
            </div>
        </div>

        <div class="flex gap-2 mb-4">
            <select id="cIn" class="flex-1 p-4 bg-white rounded-2xl font-bold outline-none border-0"></select>
            <input id="pIn" type="text" placeholder="Dove?" class="flex-1 p-4 bg-white rounded-2xl font-bold outline-none border-0 uppercase">
        </div>

        <div class="bg-white p-4 rounded-2xl mb-4">
            <div class="flex gap-2 mb-3">
                <input id="tagIn" type="text" placeholder="Tag..." class="flex-1 p-2 outline-none">
                <button onclick="aggiungiTag()" class="bg-blue-600 text-white px-4 rounded-lg">+</button>
            </div>
            <div id="tagCloud"></div>
        </div>

        <button onclick="salva()" class="w-full bg-blue-600 text-white py-5 rounded-[25px] font-black italic uppercase text-lg shadow-lg">SALVA SCHEDA</button>
    </div>

    <script>
        let configSpazi = JSON.parse(localStorage.getItem('conf')) || [{n:'CANTINA',c:'bg-zinc-800'},{n:'SOFFITTA',c:'bg-amber-600'},{n:'ARMADI',c:'bg-rose-600'},{n:'BOX',c:'bg-indigo-700'}];
        let db = JSON.parse(localStorage.getItem('db')) || [];
        let curTags = [], curPhotos = [], curQty = 1, selIdx = null;

        function render() {
            const g = document.getElementById('navGrid'), s = document.getElementById('cIn');
            g.innerHTML = ''; s.innerHTML = '';
            configSpazi.forEach((sp, i) => {
                g.innerHTML += `<button onclick="filtra('${sp.n}')" oncontextmenu="event.preventDefault();apriMenu(${i})" class="${sp.c} p-6 rounded-[25px] text-white font-black italic uppercase text-xs shadow-md">${sp.n}</button>`;
                s.innerHTML += `<option value="${sp.n}">${sp.n}</option>`;
            });
            aggiorna();
        }

        function aggiorna() {
            const grid = document.getElementById('itemsGrid');
            grid.innerHTML = db.map(o => `
                <div class="item-card">
                    <img src="${o.f[0] || ''}">
                    <div class="p-3">
                        <p class="text-[8px] font-bold text-gray-400 uppercase">${o.c}</p>
                        <h4 class="font-black italic uppercase text-[10px]">${o.n}</h4>
                        <p class="text-[9px] font-bold text-blue-600 uppercase">${o.p || 'Senza Pos.'}</p>
                    </div>
                </div>
            `).join('');
        }

        function apriMenu(i) { selIdx = i; document.getElementById('smTitle').innerText = configSpazi[i].n; document.getElementById('smartMenu').classList.add('active'); }
        function chiudiSmartMenu() { document.getElementById('smartMenu').classList.remove('active'); }
        
        function apriModale() { document.getElementById('modal').classList.remove('hidden'); }
        function chiudiModale() { document.getElementById('modal').classList.add('hidden'); }
        
        function aggiungiTag() {
            const val = document.getElementById('tagIn').value.trim();
            if(val) { curTags.push(val); document.getElementById('tagIn').value = ''; renderTags(); }
        }
        function renderTags() {
            document.getElementById('tagCloud').innerHTML = curTags.map(t => `<span class="tag-pill">${t}</span>`).join('');
        }

        function salva() {
            const n = document.getElementById('nIn').value; if(!n) return;
            db.push({ n, c: document.getElementById('cIn').value, p: document.getElementById('pIn').value, f: curPhotos, t: curTags, q: curQty });
            localStorage.setItem('db', JSON.stringify(db));
            chiudiModale(); aggiorna();
        }

        render();
    </script>
</body>
</html>
